/*! 
* Hexagons - v0.0.1
* Copyright (c) 2013 pablo novas 
*  
*/ 

!function(a){var b,c,d,e,f,g={".js":[],".json":[],".css":[],".html":[]};return e=function(a){var b=new Error("Could not find module '"+a+"'");return b.code="MODULE_NOT_FOUND",b},f=function(a,b,c){var d,e;if("function"==typeof a[b+c])return b+c;for(d=0;e=g[c][d];++d)if("function"==typeof a[b+e])return b+e;return null},b=function(a,d,g,h,i){var j,k,l,m,n,o;for(g=g.split(/[\\/]/),j=g.pop(),("."===j||".."===j)&&(g.push(j),j="");null!=(k=g.shift());)if(k&&"."!==k&&(".."===k?a=d.pop():(d.push(a),a=a[k]),!a))throw e(h);if(j&&"function"!=typeof a[j]&&(o=f(a,j,".js"),o||(o=f(a,j,".json")),o||(o=f(a,j,".css")),o||(o=f(a,j,".html")),o?j=o:2!==i&&"object"==typeof a[j]&&(d.push(a),a=a[j],j="")),!j)return 1!==i&&a[":mainpath:"]?b(a,d,a[":mainpath:"],h,1):b(a,d,"index",h,2);if(n=a[j],!n)throw e(h);return n.hasOwnProperty("module")?n.module.exports:(l={},n.module=m={exports:l},n.call(l,l,m,c(a,d)),m.exports)},d=function(c,d,f){var g,h=f,i=f.charAt(0),j=0;if("/"===i)h=h.slice(1),c=a["/"],d=[];else if("."!==i){if(g=h.split("/",1)[0],c=a[g],!c)throw e(f);d=[],h=h.slice(g.length+1),h||(h=c[":mainpath:"],h?j=1:(h="index",j=2))}return b(c,d,h,f,j)},c=function(a,b){return function(c){return d(a,[].concat(b),c)}},c(a,[])}({hexagons:{game:{"Game.js":function(a,b,c){var d=c("./Hexagons"),e=c("./Hexagon"),f=c("./helpers"),g=c("./Selector"),h=b.exports=function(a){_.extend(this,a),_.extend(this,{width:0,height:0,selector:null,boundGameRun:null,hexagons:null,hexaTypes:3,tLoop:null,points:this.initialPoints,hexaPoints:[]})};h.prototype.on=function(a,b){this.events[a]=b},h.prototype.init=function(){this.ctx=this.canvas.getContext("2d"),this.ctxSelector=this.canvasSelector.getContext("2d"),this.width=this.columns*this.size,this.height=this.rows*(this.size/1.2)+.2*this.size,this.canvas.width=this.width+150,this.canvas.height=this.height,this.canvasSelector.width=this.width,this.canvasSelector.height=this.height,this.boundGameRun=this.gameRun.bind(this);var a=this;this.input.on("move",function(b){a.hexagons.setSelection(b)}).on("select",function(){a.hexagons.resolveSequence(a.selector)}).on("left",function(){a.selector.moveAim(-1)}).on("right",function(){a.selector.moveAim(1)}),this.hexagons=new d({size:this.size,columns:this.columns,rows:this.rows,width:this.width,height:this.height,hexaTypes:this.hexaTypes})},h.prototype.update=function(a){this.hexagons.update(a),this.selector.update(a),this.currentTime=this.maxTime-hexagons.gameTime.time,this.currentTime<0&&(this.currentTime=0,this.stop()),this.formattedTime=f.timeFromMs(this.currentTime).toString()},h.prototype.draw=function(a){a.clearRect(0,0,this.canvas.width,this.canvas.height),this.hexagons.draw(a,this.onTutorial);for(var b=0,c=0;c<this.hexaPoints.length;c++){var d=this.hexaPoints[c];d.draw(a);var e=window.hexagons.counter[c];b+=e,a.font="20px Verdana",a.fillStyle="white",a.fillText("x "+e.toString(),d.x+this.size/1.5,d.y+5)}a.font="30px Verdana",a.fillText(b.toString(),this.width+50,230),a.font="30px Verdana",a.fillText(this.formattedTime,this.width+50,300),this.ctxSelector.clearRect(0,0,this.canvasSelector.width,this.canvasSelector.height),this.selector.draw(this.ctxSelector)},h.prototype.createSelector=function(){this.selector||(this.selector=new g({x:this.width/2,y:this.height/2,size:3*(this.size/2),width:this.width,height:this.height,hexagons:this.hexagons}))},h.prototype.createHexaPoints=function(){var a,b=this.size;for(this.hexaPoints=[],a=0;4>a;a++)this.hexaPoints.push(new e({x:this.width+50,y:this.hexaPoints.length*(b+5)+b,size:b,r:b/2,isSelectable:!1,type:this.hexaPoints.length,types:this.hexaTypes}));window.hexagons.tos=[],window.hexagons.counter=[],window.hexagons.patterns=[];var c=window.hexagons.repository.sprites;for(a=0;a<this.hexaPoints.length;a++){var d=this.hexaPoints[a];window.hexagons.tos.push({x:d.x,y:d.y}),window.hexagons.counter.push(0),window.hexagons.patterns.push(this.ctx.createPattern(c,"repeat"))}},h.prototype.gameRun=function(){hexagons.gameTime.tick()&&this.loop(),this.tLoop=window.requestAnimationFrame(this.boundGameRun)},h.prototype.loop=function(){this.draw(this.ctx),this.update(hexagons.gameTime.frameTime)},h.prototype.start=function(){this.createSelector(),this.createHexaPoints(),this.hexagons.createGrid(),hexagons.gameTime.reset(),this.gameRun(),this.input.enable()},h.prototype.restart=function(){this.stop(),this.start()},h.prototype.stop=function(){this.input.disable(),window.cancelAnimationFrame(this.tLoop)}},"HexaParticles.js":function(a,b,c){var d=c("./helpers"),e=b.exports=function(a){_.extend(this,a),this.sprite={img:window.hexagons.repository.sprites,x:35*this.type,y:0,xr:140,yr:0,size:this.size},_.extend(this,{size:this.size/2,particles:[],gravity:5e-4,particlesDone:[]}),this.buildParticles()};e.prototype.buildParticles=function(){for(var a=0;4>a;a++)this.particles.push({vel:{x:_.random(-10,10)/100,y:-1*_.random(15,30)/100},x:this.x+(1===a||4===a?this.size:0),y:this.y+(3===a||4===a?this.size:0),r:_.random(5,10),goingTo:!1,outOfScreen:!1});this.toX=window.hexagons.tos[this.type].x,this.toY=window.hexagons.tos[this.type].y},e.prototype.update=function(a){if(this.particlesDone.length<4)for(var b=0;b<this.particles.length;b++){var c=this.particles[b];if(!c.outOfScreen)if(c.vel.y>0&&!c.goingTo){var d={x:this.toX-c.x,y:this.toY-c.y},e=Math.sqrt(d.x*d.x+d.y*d.y);c.dir={x:d.x/e,y:d.y/e},c.coef=(c.y-this.toY)/Math.pow(c.x-this.toX,2),c.goingTo=!0}else c.goingTo?c.goingTo&&(c.x+=.9*c.dir.x*a,c.y=c.coef*Math.pow(c.x-this.toX,2)+this.toY,c.x>this.toX&&!c.outOfScreen&&(c.outOfScreen=!0,this.particlesDone.push(!0))):(c.x+=c.vel.x*a,c.y+=c.vel.y*a,c.vel.y+=this.gravity*a)}},e.prototype.draw=function(a){for(var b=this.sprite,c=0;c<this.particles.length;c++){var e=this.particles[c];e.outOfScreen||(a.beginPath(),d.drawPolygon(a,e.x,e.y,e.r,6,-Math.PI/2),a.closePath(),a.save(),a.fillStyle=a.createPattern(b.img,"repeat"),a.translate(e.x-e.r-b.x,e.y-e.r),a.fill(),a.restore(),a.drawImage(b.img,b.xr,b.yr,b.size,b.size,e.x-e.r,e.y-e.r,2*e.r,2*e.r))}}},"Hexagon.js":function(a,b,c){var d=c("./helpers"),e=b.exports=function(a){_.extend(this,a),_.extend(this,{sprite:{img:window.hexagons.repository.sprites,x:this.type*this.size,y:0,xr:140,size:this.size},selected:!1,removed:!1,fail:!1,color:"black",loadAngle:0,loadVel:.05})};e.prototype.remove=function(){this.loadAngle=0,this.removed=!0},e.prototype.update=function(a){if(this.removed&&(this.loadAngle+=this.loadVel*a,this.loadAngle>=360&&(this.type=_.random(0,this.types),this.removed=!1)),this.sprite.x=this.type*this.size,window.hexagons.settings.debug)switch(this.type){case 0:this.color="#1B75BC";break;case 1:this.color="#72BF44";break;case 2:this.color="#F58220";break;case 3:this.color="#A3238E"}},e.prototype.draw=function(a){window.hexagons.settings.debug&&(a.beginPath(),a.rect(this.x-this.r,this.y-this.r,this.size,this.size),a.strokeStyle="silver",a.stroke(),this.removed?(a.beginPath(),a.arc(this.x,this.y,this.r,0,this.loadAngle*Math.PI/180,!1),a.fillStyle="gray",a.fill()):(a.beginPath(),d.drawPolygon(a,this.x,this.y,this.r,6,-Math.PI/2),a.strokeStyle="black",a.stroke(),a.fillStyle=this.color,a.fill()),a.beginPath(),a.arc(this.x,this.y,3,0,2*Math.PI,!1),a.fillStyle="#e5dc37",a.fill());var b=this.sprite;a.save(),this.removed?(a.beginPath(),a.arc(this.x,this.y,this.r/2,0,this.loadAngle*Math.PI/180,!1),a.fillStyle="red",a.fill()):(a.beginPath(),d.drawPolygon(a,this.x,this.y,this.r,6,-Math.PI/2),a.closePath(),a.save(),a.fillStyle=window.hexagons.patterns[this.type],a.translate(this.x-this.r-b.x,this.y-this.r),a.fill(),a.restore()),a.drawImage(b.img,b.xr+1,b.y,this.size-1,this.size,this.x-this.r,this.y-this.r,this.size,this.size+1),a.restore()}},"Hexagons.js":function(a,b,c){var d=c("./helpers"),e=c("./Hexagon"),f=c("./HexaParticles"),g=b.exports=function(a){_.extend(this,a),_.extend(this,{hexagons:[],types:3,selected:null,lastId:0,hexaParticles:[]})};g.prototype.on=function(a,b){return this.events[a]=b,this},g.prototype.update=function(a){var b;for(b=0;b<this.hexagons.length;b++)this.hexagons[b].update(a);for(b=0;b<this.hexaParticles.length;b++){var c=this.hexaParticles[b];4===c.particlesDone.length?(this.removeHexaParticles(c.id),window.hexagons.counter[c.type]++):c.update(a)}},g.prototype.draw=function(a){var b;for(b=0;b<this.hexagons.length;b++)this.hexagons[b].draw(a);for(b=0;b<this.hexaParticles.length;b++)this.hexaParticles[b].draw(a)},g.prototype.removeHexaParticles=function(a){for(var b=0;b<this.hexaParticles.length;b++)this.hexaParticles[b].id===a&&this.hexaParticles.splice(b,1)},g.prototype.setSelection=function(a){function b(){for(var b=0;b<this.hexagons.length;b++){var c=this.hexagons[b];if(c.isSelectable&&d.isPointInBox(a,{x:c.x-c.r,y:c.y-c.r,size:c.size}))return c}}var c=b.call(this);c&&(this.selected=c)},g.prototype.resolveSequence=function(a){function b(a){for(var b=0;b<this.hexagons.length;b++){var c=this.hexagons[b];if(d.isPointInBox(a,{x:c.x-c.r,y:c.y-c.r,size:c.size}))return c}}if(this.selected&&!this.selected.removed){var c=this.selected.type,e=b.call(this,a.sideA),f=b.call(this,a.sideB);e&&!e.removed&&e.type===c&&f&&!f.removed&&f.type===c&&(this.selected.remove(),e.remove(),f.remove(),this.createHexaParticles(e),this.createHexaParticles(this.selected),this.createHexaParticles(f))}},g.prototype.createHexaParticles=function(a){var b=new f({id:++this.lastId,x:a.x,y:a.y,size:a.size,type:a.type});this.hexaParticles.push(b)},g.prototype.createGrid=function(){var a=this.size,b=this.width;this.hexagons=[],this.lastId=0;for(var c=0;c<this.columns;c++)for(var d=0;d<this.rows;d++)if(0!==c&&c!==this.columns-1||0!==d&&d!==this.rows-1){var f=c*a,g=d*(a/1.2),h=a/2,i=f+h+(0===d%2?0:h),j=g+h;if(!(i+h>b)){var k=!1;(0===d%2&&c>0&&c<this.columns-1&&d>0&&d<this.rows-1||0!==d%2&&c>0&&c<this.columns-2&&d>0&&d<this.rows-1)&&(k=!0);var l=_.random(0,this.types);this.hexagons.push(new e({id:this.lastId++,x:i,y:j,size:a,r:h,isSelectable:k,type:l,types:this.types}))}}}},"Selector.js":function(a,b){var c=b.exports=function(a){_.extend(this,a);var b=this.size/1.5;_.extend(this,{sprite:{img:window.hexagons.repository.sprites,x:0,y:35,size:112},dA:{x:b,y:0},dB:{x:-b,y:0},sideA:{x:0,y:0},sideB:{x:0,y:0},rotationVel:.5,angleMove:60,angle:0,nextAngle:0,dir:1,dA2:{x:this.size,y:0},dB2:{x:-this.size,y:0},sideA2:{x:0,y:0},sideB2:{x:0,y:0}})};c.prototype.moveAim=function(a){this.dir=a,this.nextAngle+=a*this.angleMove},c.prototype.update=function(a){function b(a,b){var c=b*(Math.PI/180);return{x:a.x*Math.cos(c)-a.y*Math.sin(c),y:a.x*Math.sin(c)+a.y*Math.cos(c)}}this.hexagons.selected&&(this.x=this.hexagons.selected.x,this.y=this.hexagons.selected.y),this.angle!==this.nextAngle&&(this.angle+=a*this.rotationVel*this.dir,(this.dir>0&&this.angle>this.nextAngle||this.dir<0&&this.angle<this.nextAngle)&&(this.angle=this.nextAngle));var c=b(this.dA,this.angle),d=b(this.dB,this.angle);this.sideA.x=this.x+c.x,this.sideA.y=this.y+c.y,this.sideB.x=this.x+d.x,this.sideB.y=this.y+d.y;var e=b(this.dA2,this.angle),f=b(this.dB2,this.angle);this.sideA2.x=this.x+e.x,this.sideA2.y=this.y+e.y,this.sideB2.x=this.x+f.x,this.sideB2.y=this.y+f.y},c.prototype.draw=function(a){a.beginPath(),a.moveTo(this.sideA2.x,this.sideA2.y),a.lineTo(this.sideB2.x,this.sideB2.y),a.strokeStyle="rgba(255,255,255,0.5)",a.lineWidth=20,a.stroke(),a.fillStyle="rgba(255,255,255,0.8)",window.hexagons.settings.debug&&(a.save(),a.beginPath(),a.arc(this.x,this.y,this.size,0,2*Math.PI,!1),a.strokeStyle="rgba(255,255,255,0.8)",a.lineWidth=4,a.stroke(),a.restore());var b=this.sprite,c=this.size;a.drawImage(b.img,b.x,b.y,b.size,b.size,this.x-c-3,this.y-c-3,2*c+8,2*c+7)}},"gameTime.js":function(a,b){var c=b.exports={lastTime:Date.now(),frameTime:0,typicalFrameTime:20,minFrameTime:12,time:0};c.tick=function(){var a=Date.now(),b=a-this.lastTime;return b<this.minFrameTime?!1:(this.frameTime=b>2*this.typicalFrameTime?this.typicalFrameTime:b,this.time+=this.frameTime,this.lastTime=a,!0)},c.reset=function(){this.lastTime=Date.now(),this.frameTime=0,this.typicalFrameTime=20,this.minFrameTime=12,this.time=0}},"helpers.js":function(a,b){b.exports={doBoxesVerticalCollide:function(a,b){return a.y<b.y+b.size&&b.y<=a.y+a.size},isPointInBox:function(a,b){return a.y>b.y&&a.y<b.y+b.size&&a.x>b.x&&a.x<b.x+b.size},drawPolygon:function(a,b,c,d,e,f,g){if(!(3>e)){var h=2*Math.PI/e;h=g?-h:h,a.save(),a.translate(b,c),a.rotate(f),a.moveTo(d,0);for(var i=1;e>i;i++)a.lineTo(d*Math.cos(h*i),d*Math.sin(h*i));a.closePath(),a.restore()}},timeFromMs:function(a){function b(a){return 10>a?"0"+a:a}var c=moment.duration(a),d=b(c.minutes()),e=b(c.seconds());return d+":"+e}}},"index.js":function(a,b,c){var d=c("./Game"),e=c("./input.mouse"),f=c("./loader");$(function(){function a(){var a=_.clone(hexagons.settings);a.canvas=document.getElementById("game-viewport"),a.canvasSelector=document.getElementById("game-selector"),a.input=new e({container:a.canvasSelector}),a.lives=3;var b=new d(a);b.init(),$(".game-ctn").width(b.width+150).height(b.height),window.game=b,b.restart(),$("#play").on("click",function(){b.start()}),$("#restart").on("click",function(){b.restart()}),$("#controls").on("click",function(){$(".controls-modal").toggle()}),$(".controls-modal a.close").on("click",function(){$(".controls-modal").hide()})}window.hexagons={repository:c("./repository"),sounds:c("./sounds"),settings:c("./settings"),gameTime:c("./gameTime")},f.initResources(hexagons.settings.images,hexagons.settings.sounds).on("error",function(a){window.console.log(a)}).on("report",function(a){hexagons.settings.debug&&window.console.log("LOADING > "+a),$("#progressbar").css({width:a+"%"})}).on("complete",function(){a()}).load()})},"input.mouse.js":function(a,b){var c=b.exports=function(a){this.container=a.container||window.document,this.events={select:null,move:null,left:null,right:null},this.enabled=!1,this.onSelect=this._onContainerSelect.bind(this),$(this.container).on("click",this.onSelect),this.onMove=this._onContainerMove.bind(this),$(this.container).on("mousemove",this.onMove),this.keyUp=this._onContainerKeyUp.bind(this),$(document).on("keyup",this.keyUp)};c.prototype.enable=function(){return this.enabled=!0,this},c.prototype.disable=function(){return this.enabled=!1,this},c.prototype.on=function(a,b){return this.events[a]||(this.events[a]=[]),this.events[a].push(b),this},c.prototype._onContainerSelect=function(a){if(this.enabled){var b=$(a.target).offset(),c=a.pageX-b.left,d=a.pageY-b.top;_.each(this.events.select,function(a){a({x:c,y:d})})}},c.prototype._onContainerMove=function(a){if(this.enabled){var b=$(a.target).offset(),c=a.pageX-b.left,d=a.pageY-b.top;_.each(this.events.move,function(a){a({x:c,y:d})})}},c.prototype._onContainerKeyUp=function(a){if(this.enabled){var b=a.which||a.keyCode,c=null;switch(b){case 65:case 97:c="left";break;case 68:case 100:c="right"}c&&_.each(this.events[c],function(a){a()})}}},"loader.js":function(a,b){function c(){!h&&f>=50&&g>=50&&(h=!0,e.complete())}function d(){e.report(f+g)}var e={complete:function(){},report:function(){},error:function(){}},f=0,g=0,h=!1;b.exports={initResources:function(a,b){return window.hexagons.repository.addResources(a).on("error",e.error).on("report",function(a){f=a/2,d(),c()}).on("complete",c),window.hexagons.sounds.addSounds(b).on("error",e.error).on("report",function(a){g=a/2,d(),c()}).on("complete",c),this},on:function(a,b){return e[a]&&(e[a]=b),this},load:function(){window.hexagons.repository.load(),window.hexagons.sounds.load(window.hexagons.settings.soundsUrl)}}},"repository.js":function(a,b){b.exports=function(){var a={},b=0,c=function(){return Object.keys(a).length},d={complete:function(){},report:function(){},error:function(){}},e=function(){var a=c(),e=100*++b/a;a>=b&&(d.report(e),e>=100&&d.complete())},f=function(a,b){d.error(a,b)};return{on:function(a,b){return d[a]&&(d[a]=b),this},loadOne:function(b,c,d){var e=c||function(){},f=d||function(){};if(!b)throw"Parameter 'name' not specify";if(!a[b])throw"Resource "+b+" not found!. Use addReource() before load.";return this[b]=new window.Image,this[b].onload=e,this[b].onerror=f,this[b].complete&&e(),this[b].src=a[b],this},load:function(){b=0;for(var c in a)a.hasOwnProperty(c)&&(this[c]=new window.Image,this[c].onload=e,this[c].onerror=f,this[c].complete&&e(),this[c].src=a[c]);return this},addResources:function(b){for(var c in b)if(b.hasOwnProperty(c)){if(a.hasOwnProperty(c))throw"The resource "+c+" already exists.";a[c]=b[c]}return this},clear:function(){var b=c();do this[a[b]]&&(this[a[b]]=null,delete this[a[b]]);while(b--);a={}}}}()},"settings.js":function(a,b){b.exports={debug:!1,size:35,columns:15,rows:15,maxTime:18e4,images:{sprites:"dist/images/sprites.png"},soundsUrl:"dist/sounds",sounds:{x:{file:"blop_1"}}}},"sounds.js":function(a,b){b.exports=function(){function a(){var a=f(),b=100*++e/a;a>=e&&(g.report(b),b>=100&&g.complete())}function b(a,b){g.error(a,b)}function c(c,e){var f=_.clone(d[c]),g=f.formats||["mp3","ogg","wav"],h=_.map(g,function(a){return e+"/"+f.file+"."+a});d[c]=new Howl({urls:h,buffer:!0,autoplay:!1,volume:f.volume||.5,onload:a,onloaderror:b})}var d={},e=0,f=function(){return Object.keys(d).length},g={complete:function(){},report:function(){},error:function(){}};return{on:function(a,b){return g[a]&&(g[a]=b),this},load:function(a){e=0;for(var b in d)d.hasOwnProperty(b)&&c(b,a);return this},addSounds:function(a){for(var b in a)if(a.hasOwnProperty(b)){if(d.hasOwnProperty(b))throw"The sound "+b+" already exists.";d[b]=a[b]}return this},play:function(a,b,c){d[a]&&(c&&d[a].loop(!0),b?d[a].fadeIn(d[a].volume(),b):d[a].play())},stop:function(a,b){d[a]&&(b?d[a].fadeOut(0,b):d[a].stop())},muteAll:function(){Howler.mute()},unmuteAll:function(){Howler.unmute()},setVolume:function(a){Howler.volume(a)}}}()}}}})("hexagons/game/index");